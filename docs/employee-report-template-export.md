# Employee Report Template Export - Dokumentacija sustava

## 1. Pregled sustava

### Svrha
`EmployeeReportTemplateExport` generira mjesečni Excel izvještaj radnih sati zaposlenika popunjavanjem podataka u postojeći XLSX predložak ("evidencija radnog vremena"). Predložak sadrži 12 sheetova (jedan za svaki mjesec) s predefiniranim rasporedom ćelija, formulama i formatiranjem.

### Tri export klase u sustavu

| Klasa | Svrha | Kad se koristi |
|-------|-------|----------------|
| `EmployeeReportTemplateExport` | Popunjava službeni XLSX predložak s podacima zaposlenika | Default kad je `enable_autogenerated=false`; opcija "Službeni predložak" kad je `enable_autogenerated=true` |
| `EmployeeReportExport` | Generira Excel od nule pomoću Maatwebsite/Excel (FromArray) | Fallback ako template ne postoji; opcija "Generirani Excel izvještaj" kad je `enable_autogenerated=true` |
| `AllEmployeTimeReportExport` | Sumarni izvještaj svih zaposlenika u jednom Excelu | Header action na listi zaposlenika (samo admin) |

### Odnos između klasa

```
enable_autogenerated=false (DEFAULT):
  → EmployeeReportTemplateExport (template-based)
  → fallback na EmployeeReportExport ako template ne postoji

enable_autogenerated=true:
  → Korisnik bira:
    - "Službeni predložak" → EmployeeReportTemplateExport
    - "Generirani Excel izvještaj" → EmployeeReportExport
```

---

## 2. Arhitektura i Data Flow

### Kompletni flow

```
┌─────────────────────────────────────────────────────────────────┐
│                        FILAMENT UI                              │
│                                                                 │
│  ┌─────────────────────┐    ┌──────────────────────────────┐    │
│  │ MonthlySummaryWidget │    │ EmployeeTable (header action)│    │
│  │ (View Employee page) │    │ (admin only, svi zaposlenici)│    │
│  └──────────┬──────────┘    └──────────────┬───────────────┘    │
│             │                              │                     │
│             ▼                              ▼                     │
│  ┌─────────────────────────────────────────────────────┐        │
│  │          EmployeeAction                              │        │
│  │  downloadMonthlyTimeReportAction(Employee $record)   │        │
│  │  allEmployeTimeReportExport()                        │        │
│  └──────────────────────┬──────────────────────────────┘        │
└─────────────────────────┼───────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    EXPORT LAYER                                  │
│                                                                 │
│  ┌───────────────────────────┐                                  │
│  │ EmployeeReportTemplateExport                                 │
│  │                           │                                  │
│  │  1. getTemplatePath()     │  ← config + fallback paths       │
│  │  2. Load XLSX template    │  ← PhpSpreadsheet IOFactory      │
│  │  3. Select month sheet    │                                  │
│  │  4. Get report data ──────┼──► Employee::getMonthlyWorkReport│
│  │  5. Fill header cells     │                                  │
│  │  6. Clear old values      │                                  │
│  │  7. Fill daily data       │                                  │
│  │  8. Fill work times       │                                  │
│  │  9. Set number formats    │                                  │
│  │ 10. Add SUM formulas      │                                  │
│  │ 11. Apply day formatting  │                                  │
│  │ 12. Save to temp file     │                                  │
│  │ 13. Return download       │                                  │
│  └───────────────────────────┘                                  │
└─────────────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────────────┐
│                    DATA LAYER                                    │
│                                                                 │
│  Employee::getMonthlyWorkReport(Carbon $month)                  │
│  ├── Holiday::getHolidaysForMonth()                             │
│  ├── TimeLogs (SUM hours, SUM WFH hours, grouped by date)      │
│  └── LeaveRequests (overlapping with month, cursor iteration)   │
│                                                                 │
│  Vraća: ['daily_data' => [...], 'totals' => [...]]              │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. Konfiguracija

### Config datoteka
**Path**: `config/employee-management.php` → sekcija `monthly_report`

### Config ključevi

| Ključ | Env varijabla | Default | Opis |
|-------|---------------|---------|------|
| `monthly_report.template_path` | `EMPLOYEE_REPORT_TEMPLATE_PATH` | `templates/evidencija_radnog_vremena.xlsx` | Relativni path do XLSX predloška (relativno od `storage/`) |
| `monthly_report.enable_autogenerated` | `EMPLOYEE_REPORT_ENABLE_AUTOGENERATED` | `false` | Omogućava izbor između template-based i generated exporta |

### Template file path resolution

```php
// 1. Primarni path: storage/{config_value}
$primaryPath = storage_path(config('employee-management.monthly_report.template_path'));

// 2. Fallback pathovi (redom):
storage_path('templates/evidencija_radnog_vremena.xlsx')
storage_path('app/templates/evidencija_radnog_vremena.xlsx')
storage_path('templates/evidencija_radnog_vremena_2025.xlsx')
storage_path('app/templates/evidencija_radnog_vremena_2025.xlsx')

// 3. Ako nijedan ne postoji → Exception
```

### Logika izbora exporta u UI

```php
// EmployeeAction::downloadMonthlyTimeReportAction()

if (config('employee-management.monthly_report.enable_autogenerated', false)) {
    // Prikaži Select za tip predloška s opcijama:
    // 'generated' => 'Generirani Excel izvještaj'
    // 'ods_template' => 'Službeni predložak (evidencija radnog vremena)'
    // Default: 'ods_template'
} else {
    // NE prikazuj Select - koristi template-based export (ods_template)
    // Ako template ne postoji → automatski fallback na EmployeeReportExport
}
```

---

## 4. Excel Template Struktura

### Sheetovi
Template sadrži **12 sheetova**, jedan za svaki mjesec, s hrvatskim nazivima:

| Index | Naziv sheeta |
|-------|-------------|
| 1 | Siječanj |
| 2 | Veljača |
| 3 | Ožujak |
| 4 | Travanj |
| 5 | Svibanj |
| 6 | Lipanj |
| 7 | Srpanj |
| 8 | Kolovoz |
| 9 | Rujan |
| 10 | Listopad |
| 11 | Studeni |
| 12 | Prosinac |

### Header ćelije

| Ćelija | Sadržaj | Napomena |
|--------|---------|---------|
| `D3` | Ime i prezime zaposlenika | Merged ćelija D3:K3 |
| `D4` | Naziv odjela | Merged ćelija D4:N4 |
| `W4` | `"Radno mjesto: {job_position}"` | Samo ako zaposlenik ima popunjeno `job_position` |
| `L3` | Naslov s mjesecom i godinom | Regex zamjena godine i mjeseca u postojećem tekstu |

### Radno vrijeme header (rows 3-4)

Za svaki radni dan (ne vikend, ne praznik):
- `{col}3` = `7` (početak rada, 7:00)
- `{col}4` = `15` (završetak rada, 15:00)

### Day columns mapping (Stupci za dane)

Dani 1-31 su mapirani na stupce D-AH:

```
Dan  1 = D     Dan  9 = L     Dan 17 = T     Dan 25 = AB
Dan  2 = E     Dan 10 = M     Dan 18 = U     Dan 26 = AC
Dan  3 = F     Dan 11 = N     Dan 19 = V     Dan 27 = AD
Dan  4 = G     Dan 12 = O     Dan 20 = W     Dan 28 = AE
Dan  5 = H     Dan 13 = P     Dan 21 = X     Dan 29 = AF
Dan  6 = I     Dan 14 = Q     Dan 22 = Y     Dan 30 = AG
Dan  7 = J     Dan 15 = R     Dan 23 = Z     Dan 31 = AH
Dan  8 = K     Dan 16 = S     Dan 24 = AA
```

### Hour type rows mapping (Redovi za tipove sati)

**Mjeseci 1-10 (Siječanj - Listopad):**

| Row | Tip sati | Hrvatski naziv |
|-----|----------|----------------|
| 16 | `vacation_hours` | Godišnji odmor |
| 17 | `holiday_hours` | Plaćeni neradni dani i blagdani |
| 18 | `sick_leave_hours` | Bolovanje |
| 20 | `maternity_leave_hours` | Rodiljni dopust |
| 22 | `other_hours` | Plaćeni dopust |
| 30 | `work_hours` | Redovan rad |
| 32 | `work_from_home_hours` | Rad na daljinu |
| 33 | `overtime_hours` | Prekovremeni sati |

**Mjeseci 11-12 (Studeni - Prosinac):**

Redovi se pomiču za +1 nakon row 20 zbog dodatnog reda "Mirovanje radnog odnosa" na row 21:

| Row | Tip sati | Hrvatski naziv |
|-----|----------|----------------|
| 16 | `vacation_hours` | Godišnji odmor |
| 17 | `holiday_hours` | Plaćeni neradni dani i blagdani |
| 18 | `sick_leave_hours` | Bolovanje |
| 20 | `maternity_leave_hours` | Rodiljni dopust |
| **23** | `other_hours` | Plaćeni dopust *(shifted +1)* |
| **31** | `work_hours` | Redovan rad *(shifted +1)* |
| **33** | `work_from_home_hours` | Rad na daljinu *(shifted +1)* |
| **34** | `overtime_hours` | Prekovremeni sati *(shifted +1)* |

### Total column pozicija

Total stupac ovisi o broju dana u mjesecu:

| Broj dana | Total stupac |
|-----------|-------------|
| 28 | AF |
| 29 | AG |
| 30 | AH |
| 31 | AI |

### Total formule

- Rows 14 do `$lastDataRow` (33 za mj. 1-10, 34 za mj. 11-12): `=SUM(D{row}:{lastDayCol}{row})`
- Grand total row (`$lastDataRow + 1`): `=SUM({totalCol}14:{totalCol}{lastDataRow})`

---

## 5. Logika popunjavanja podataka

### Korak 1: Brisanje prethodnih vrijednosti

Prije popunjavanja, sve ćelije u template-u za sve dane i sve tipove sati se postavljaju na `null`:

```php
foreach ($this->dayColumns as $day => $col) {
    foreach ($this->hourTypeRows as $row) {
        $sheet->setCellValue($col . $row, null);
    }
}
```

### Korak 2: Popunjavanje dnevnih podataka

Za svaki dan u mjesecu, iz `daily_data` arraya:

#### Leave tipovi (direktno mapiranje)
- `vacation_hours` > 0 → upiši u row za godišnji odmor
- `holiday_hours` > 0 → upiši u row za blagdane
- `sick_leave_hours` > 0 → upiši u row za bolovanje
- `maternity_leave_hours` > 0 → upiši u row za rodiljni
- `other_hours` > 0 → upiši u row za plaćeni dopust

#### Business logika za radne sate

```
1. VIKEND (is_weekend = true):
   → SVE radne sate → overtime_hours row (33 ili 34)
   → Neovisno o WFH ili ured

2. RADNI DAN + RAD OD KUĆE (total_wfh_hours > 0):
   → Prvih min(wfh_hours, 8) → work_from_home_hours row (32 ili 33)
   → Ako total_hours > 8 → (total_hours - 8) → overtime_hours row

3. RADNI DAN + URED (total_wfh_hours = 0):
   → Prvih min(total_hours, 8) → work_hours row (30 ili 31)
   → Ako total_hours > 8 → (total_hours - 8) → overtime_hours row
```

**Vizualno:**

```
                    ┌─── Vikend? ──── DA ──→ Svi sati → Prekovremeni (row 33/34)
                    │
total_hours > 0 ────┤
                    │                ┌── WFH? ── DA ──→ min(wfh, 8) → Rad na daljinu (row 32/33)
                    └─── Radni dan? ─┤                  ostatak → Prekovremeni (row 33/34)
                                     │
                                     └── Ured ────────→ min(total, 8) → Redovan rad (row 30/31)
                                                        ostatak → Prekovremeni (row 33/34)
```

### Korak 3: Number format

Sve data ćelije koriste `FORMAT_GENERAL` - automatski prikazuje cijele brojeve bez decimala, a decimale s do 2 decimalna mjesta.

---

## 6. Vizualno formatiranje

### Pozadine ćelija (applyDayFormatting)

Za svaki dan u mjesecu, formatiraju se **svi redovi od 7 do 33** (ili 7 do 34 za studeni/prosinac):

| Uvjet | Boja pozadine | ARGB kod | Fill tip |
|-------|---------------|----------|----------|
| Praznik (is_holiday) | Crvena | `FFFF0000` | FILL_SOLID |
| Vikend (subota/nedjelja) | Svijetlo siva | `FFD3D3D3` | FILL_SOLID |
| Radni dan | Bijela | - | FILL_NONE |

### Prioritet formatiranja
Praznici imaju prednost nad vikendom - ako praznik padne na vikend, ćelija je **crvena**.

### Range formatiranja
- Start row: **7**
- End row: **33** (mjeseci 1-10) ili **34** (mjeseci 11-12)

---

## 7. Employee::getMonthlyWorkReport() - Izvor podataka

### Potpis metode

```php
public function getMonthlyWorkReport(Carbon $month): array
```

### Povratna struktura

```php
[
    'daily_data' => [
        [
            'date' => Carbon,              // Datum
            'work_hours' => float,          // Redovni radni sati (ured)
            'work_from_home_hours' => float, // Sati rada od kuće
            'overtime_hours' => float,       // Prekovremeni sati
            'vacation_hours' => float,       // Godišnji odmor (8h ili 0)
            'sick_leave_hours' => float,     // Bolovanje (8h ili 0)
            'other_hours' => float,          // Plaćeni dopust (8h ili 0)
            'maternity_leave_hours' => float, // Rodiljni dopust (8h ili 0)
            'holiday_hours' => float,        // Praznik (8h ili 0)
            'is_holiday' => bool,            // Je li javni praznik
            'total_hours' => float,          // Ukupni logirani sati (iz TimeLog)
            'total_wfh_hours' => float,      // Ukupni WFH sati (iz TimeLog)
            'is_weekend' => bool,            // Je li vikend (sub/ned)
        ],
        // ... za svaki dan u mjesecu
    ],
    'totals' => [
        'work_hours' => float,
        'work_from_home_hours' => float,
        'overtime_hours' => float,
        'vacation_hours' => float,
        'sick_leave_hours' => float,
        'other_hours' => float,
        'maternity_leave_hours' => float,
        'holiday_hours' => float,
        'available_hours' => float,  // Ukupno predviđenih radnih sati u mjesecu
    ],
]
```

### Logika izračuna po danu

```
Za svaki dan u mjesecu:

1. Dohvati TimeLog podatke (SUM hours, SUM wfh_hours grupirane po datumu)
2. Dohvati LeaveRequest za taj datum (ako postoji, odobren, overlaps s mjesecom)

3. PRIORITET IZRAČUNA:
   a) Ako postoji LeaveRequest za radni dan:
      → Postavi 8h na odgovarajući tip leave-a (vacation/sick/paid/maternity)

   b) Ako je javni praznik I radni dan:
      → OVERRIDE: poništi sve leave sate
      → Postavi holiday_hours = 8h
      → (praznici imaju prednost nad leave requestima)

   c) Ako je radni dan, NIJE praznik, NEMA leave:
      → Izračunaj work_hours, wfh_hours, overtime iz TimeLog podataka
      → Ako total > 8h: regular = max(0, 8 - wfh), overtime = total - 8

   d) Ako NIJE radni dan ili JE praznik ili JE na leave:
      → Svi TimeLog sati idu u overtime

4. available_hours: +8h za svaki radni dan koji NIJE praznik
```

### Konstante

```php
Employee::HOURS_PER_WORK_DAY = 8
Employee::WORK_DAYS = [Carbon::MONDAY, Carbon::TUESDAY, Carbon::WEDNESDAY, Carbon::THURSDAY, Carbon::FRIDAY]
```

### SQL upiti (optimizirani)

```php
// TimeLogs - jedan agregirani upit za cijeli mjesec
$this->timeLogs()
    ->whereYear('date', $month->year)
    ->whereMonth('date', $month->month)
    ->selectRaw('date, SUM(hours) as total_hours, SUM(CASE WHEN is_work_from_home = 1 THEN hours ELSE 0 END) as wfh_hours')
    ->groupBy('date')
    ->get()
    ->keyBy(fn ($log) => Carbon::parse($log->date)->format('Y-m-d'));

// LeaveRequests - cursor za memory efficiency
$this->leaveRequests()
    ->where(function ($query) use ($month) {
        $query->where(function ($q) use ($month) {
            $q->whereYear('start_date', $month->year)->whereMonth('start_date', $month->month);
        })->orWhere(function ($q) use ($month) {
            $q->whereYear('end_date', $month->year)->whereMonth('end_date', $month->month);
        });
    })
    ->cursor();

// Holidays - statička metoda
Holiday::getHolidaysForMonth($month); // Vraća array Y-m-d stringova
```

---

## 8. Povezani modeli i enumi

### Modeli

#### Employee (`src/Models/Employee.php`)
- **Namespace**: `Amicus\FilamentEmployeeManagement\Models\Employee`
- **Ključna polja**: `first_name`, `last_name`, `email`, `department_id`, `job_position`, `is_active`
- **Relacije**: `department()` → BelongsTo Department, `timeLogs()` → HasMany TimeLog, `leaveRequests()` → HasMany LeaveRequest, `leaveAllowances()` → HasMany LeaveAllowance
- **Computed**: `full_name` (accessor, dodaje "(NEAKTIVAN / OBRISAN)" za neaktivne)
- **Bitno**: Ima global scope za `active` (trenutno zakomentirano)
- **Trait**: `HasEmployeeRole`, `HasRoles` (Spatie)

#### TimeLog (`src/Models/TimeLog.php`)
- **Namespace**: `Amicus\FilamentEmployeeManagement\Models\TimeLog`
- **Ključna polja**: `employee_id`, `date`, `hours` (decimal:2), `description`, `status` (TimeLogStatus), `log_type` (LogType), `is_work_from_home` (bool)
- **Relacija**: `employee()` → BelongsTo Employee (withTrashed)
- **Statička metoda**: `fillMonthWithDefaultHours()` - popunjava 8h za sve radne dane bez postojećih unosa

#### LeaveRequest (`src/Models/LeaveRequest.php`)
- **Namespace**: `Amicus\FilamentEmployeeManagement\Models\LeaveRequest`
- **Ključna polja**: `employee_id`, `leave_allowance_id`, `type` (LeaveRequestType), `status` (LeaveRequestStatus), `start_date`, `end_date`, `days_count`
- **Approval flow**: Dvostupanjsko odobrenje - voditelj odjela + direktor
- **Observer**: `LeaveRequestObserver` - auto-approval za SICK_LEAVE i MATERNITY_LEAVE
- **Statička metoda**: `getLeaveRequestsForDate($employeeId, $date)` - vraća samo APPROVED zahtjeve

#### Holiday (`src/Models/Holiday.php`)
- **Namespace**: `Amicus\FilamentEmployeeManagement\Models\Holiday`
- **Ključna polja**: `name`, `date`, `is_recurring` (bool)
- **Logika**: Podržava recurring (godišnji) i non-recurring (jednokratni) praznike
- **Statička metoda**: `getHolidaysForMonth($month)` - vraća array datuma u 'Y-m-d' formatu

#### Department (`src/Models/Department.php`)
- **Ključna polja**: `name`, `head_of_department_employee_id`
- **Relacije**: `employees()` → HasMany Employee, `headOfDepartment()` → BelongsTo Employee

#### LeaveAllowance (`src/Models/LeaveAllowance.php`)
- **Ključna polja**: `employee_id`, `year`, `total_days`, `valid_until_date`
- **Computed**: `used_days` (sum days_count approved leave requests), `available_days` (total - used)

### Enumi

#### LeaveRequestType (`src/Enums/LeaveRequestType.php`)
```php
enum LeaveRequestType: string {
    case ANNUAL_LEAVE = 'godisnji';        // Godišnji odmor
    case SICK_LEAVE = 'bolovanje';          // Bolovanje (auto-approved)
    case PAID_LEAVE = 'placeni_slobodan_dan'; // Plaćeni slobodan dan
    case MATERNITY_LEAVE = 'porodiljni';    // Porodiljni (auto-approved)
}
```
- `isAutoApproved()`: Vraća `true` za SICK_LEAVE i MATERNITY_LEAVE

#### LeaveRequestStatus (`src/Enums/LeaveRequestStatus.php`)
```php
enum LeaveRequestStatus: string {
    case PENDING = 'pending';    // Na čekanju (warning)
    case APPROVED = 'approved';  // Odobreno (success)
    case REJECTED = 'rejected';  // Odbijeno (danger)
    case CANCELED = 'canceled';  // Otkazano (secondary)
}
```

#### TimeLogStatus (`src/Enums/TimeLogStatus.php`)
```php
enum TimeLogStatus: string {
    case PLANNED = 'planned';      // Planirano
    case CONFIRMED = 'confirmed';  // Potvrđeno (default)
}
```

#### LogType (`src/Enums/LogType.php`)
```php
enum LogType: string {
    case RADNI_SATI = 'radni_sati';
    case BOLOVANJE = 'bolovanje';
    case GODISNJI = 'godisnji';
    case PLACENI_SLOBODAN_DAN = 'placeni_slobodan_dan';
}
```

---

## 9. UI integracija (Filament)

### EmployeeAction::downloadMonthlyTimeReportAction(Employee $record)

**Lokacija**: `src/Filament/Clusters/HumanResources/Resources/EmployeeResource/Actions/EmployeeAction.php`

Modal s poljima:
1. **Tip predloška** (Select, samo kad `enable_autogenerated=true`):
   - `generated` → EmployeeReportExport
   - `ods_template` → EmployeeReportTemplateExport (default)
2. **Mjesec** (Select, 1-12, default: trenutni mjesec)
3. **Godina** (Select, range: current-2 do current+1, default: trenutna godina)

**Naziv datoteke**: `izvjestaj-radnih-sati-{ime}-{mjesec}-{godina}.xlsx`

**Fallback mehanizam**:
```
template_type === 'ods_template'
  → try: EmployeeReportTemplateExport::download()
  → catch: report($e) + fallback na EmployeeReportExport
```

### EmployeeAction::allEmployeTimeReportExport()

Header action na listi zaposlenika, vidljiv samo za admine. Koristi `AllEmployeTimeReportExport` za generiranje sumarnog izvještaja svih zaposlenika.

### MonthlySummaryWidget

**Lokacija**: `src/Filament/Clusters/HumanResources/Resources/EmployeeResource/Widgets/MonthlySummaryWidget.php`

Widget na View Employee stranici koji prikazuje:
- Navigacija mjesecima (prethodni/sljedeći/trenutni)
- Sažetak sati (KeyValueEntry) - poziva `Employee::getMonthlyWorkReport()`
- Akcije:
  - **Mjesečni izvještaj radnih sati** → delegira na `EmployeeAction::downloadMonthlyTimeReportAction()`
  - **Pošalji na pregled** → submitForReview (za zaposlenika, approvera, admina)
  - **Zatvori mjesec** → closeMonth/approveAndLock (samo approver)
  - **Vrati na ispravak** → returnForCorrection (approver/admin)

### EmployeeTable

**Lokacija**: `src/Filament/Clusters/HumanResources/Resources/EmployeeResource/Tables/EmployeeTable.php`

Header action `allEmployeTimeReportExport()` - bottom positioned, vidljiv samo za admine.

---

## 10. Ključne datoteke

### Export klase
- `src/Exports/EmployeeReportTemplateExport.php` - Template-based export (glavna klasa)
- `src/Exports/EmployeeReportExport.php` - Generated export (Maatwebsite/Excel)
- `src/Exports/AllEmployeTimeReportExport.php` - Sumarni izvještaj svih zaposlenika

### Modeli
- `src/Models/Employee.php` - Model zaposlenika + `getMonthlyWorkReport()`
- `src/Models/TimeLog.php` - Evidencija radnih sati
- `src/Models/LeaveRequest.php` - Zahtjevi za odsutnost
- `src/Models/Holiday.php` - Praznici
- `src/Models/Department.php` - Odjeli
- `src/Models/LeaveAllowance.php` - Godišnji fond dana
- `src/Models/MonthlyWorkReport.php` - Mjesečni izvještaj (status tracking)

### Enumi
- `src/Enums/LeaveRequestType.php`
- `src/Enums/LeaveRequestStatus.php`
- `src/Enums/TimeLogStatus.php`
- `src/Enums/LogType.php`

### Filament UI
- `src/Filament/Clusters/HumanResources/Resources/EmployeeResource/Actions/EmployeeAction.php`
- `src/Filament/Clusters/HumanResources/Resources/EmployeeResource/Tables/EmployeeTable.php`
- `src/Filament/Clusters/HumanResources/Resources/EmployeeResource/Widgets/MonthlySummaryWidget.php`

### Konfiguracija
- `config/employee-management.php` - Sekcija `monthly_report`

### Template
- `storage/templates/evidencija_radnog_vremena.xlsx` - Default XLSX predložak (12 sheetova)

---

## 11. Česte greške i edge cases

### Row shift za studeni/prosinac
Mjeseci 11 i 12 imaju pomak +1 za redove nakon row 20 zbog "Mirovanje radnog odnosa". Kod automatski koristi `$hourTypeRowsNovemberDecember` mapping kad je `$month` 11 ili 12.

### Praznik na radni dan vs. leave
Ako zaposlenik ima odobren godišnji/bolovanje na dan koji je ujedno i praznik, **praznik ima prednost** - leave sati se postavljaju na 0, a `holiday_hours` na 8h.

### Weekend + rad
Svi sati rada na vikendu automatski idu u prekovremene, neovisno je li to rad iz ureda ili od kuće.

### Template ne postoji
Ako template file ne postoji, `getTemplatePath()` baca Exception. U UI-ju, EmployeeAction hvata exception i fallbacka na `EmployeeReportExport`.

### Memory i timeout
`download()` metoda povećava `time_limit` na 300s i `memory_limit` na 512M jer PhpSpreadsheet operacije mogu biti zahtjevne.

### Temp file cleanup
Download response koristi `->deleteFileAfterSend(true)` tako da se temp file automatski briše nakon slanja.
